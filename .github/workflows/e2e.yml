name: SalesforceCommerceCloud/pwa-kit/e2e
on:
  workflow_dispatch:
    inputs:
      extend:
        type: boolean
        description: extend
        default: true
      name:
        type: string
        description: name
        default: "scaffold-pwa"
      instanceUrl:
        type: string
        description: instanceUrl
        default: "https://zzrf-002.dx.commercecloud.salesforce.com"
      orgId:
        type: string
        description: orgId
        default: "f_ecom_zzrf_002"
      shortCode:
        type: string
        description: shortCode
        default: "kv7kzm78"
      clientId:
        type: string
        description: clientId
        default: "cfa08695-89e9-4519-ab9e-d2a99cb0bea8"
      siteId:
        type: string
        description: siteId
        default: "RefArch"
      isPrivateClient:
        type: boolean
        description: isPrivateClient
        default: true
      hybrid:
        type: boolean
        description: hybrid
        default: false
      mrtTargetEnv:
        type: string
        description: mrtTargetEnv
        default: "hyperforce"

jobs:
  pwa-kit:
    runs-on: ubuntu-latest
    steps:
      - name: Set environment variable
        run: |      
          url="${{ github.event.inputs.instanceUrl }}"
          hostname=$(echo "$url" | awk -F '://' '{split($2, parts, "/"); print parts[1]}')
          echo "Hostname: $hostname"
          echo "HOSTNAME: $hostname" >> $GITHUB_ENV 

      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # Based on PWA setup_ubuntu script but with extra tests cut out
      - name: Setup PWA dependencies
        #working-directory: './pwa'
        run: |-
          # Install system dependencies
          sudo apt-get update -yq
          sudo apt-get install python2 python3-pip time -yq
          sudo pip install -U pip setuptools
          sudo pip install awscli==1.18.85 datadog==0.40.1

          # Install node dependencies
          node ./scripts/gtime.js monorepo_install npm ci

          # Install PWA dependencies
          npm ci
        shell: bash

      - name: Generate app
        uses: "./.github/actions/generate_app"
        with:
          extend: ${{ github.event.inputs.extend }}
          name: ${{ github.event.inputs.name }}
          instanceUrl: ${{ github.event.inputs.instanceUrl }}
          orgId: ${{ github.event.inputs.orgId }}
          shortCode: ${{ github.event.inputs.shortCode }}
          clientId: ${{ github.event.inputs.clientId }}
          siteId: ${{ github.event.inputs.siteId }}
          isPrivateClient: ${{ github.event.inputs.isPrivateClient }}
          hybrid: ${{ github.event.inputs.hybrid }}

      - name: Create MRT credentials file
        uses: "./.github/actions/create_mrt"
        with:
          mobify_user: ${{ secrets.MOBIFY_CLIENT_USER }}
          mobify_api_key: ${{ secrets.MOBIFY_CLIENT_API_KEY }}

       - name: Push Bundle to MRT (E2E Test PWA Kit)
        uses: "./.github/actions/push_to_mrt"
        with:
          CWD: "../generated-projects/my-retail-react-app"
          TARGET: hyperforce
          FLAGS: --wait

